<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thử nghiệm Chat Audio</title>
    <style>
        /* --- General Styles --- */
        :root {
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --background-color: #f0f2f5;
            --container-bg: #ffffff;
            --text-color: #333;
            --user-msg-bg: #007bff;
            --user-msg-color: #fff;
            --ai-msg-bg: #e9e9eb;
            --ai-msg-color: #000;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--background-color);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--text-color);
        }

        /* --- Chat Container --- */
        .chat-container {
            width: 100%;
            max-width: 700px;
            height: 80vh;
            background-color: var(--container-bg);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* --- Header --- */
        .chat-header {
            padding: 1rem;
            background-color: var(--primary-color);
            color: white;
            text-align: center;
            font-size: 1.25rem;
            font-weight: 600;
        }

        /* --- Message Log --- */
        .chat-log {
            flex-grow: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            display: flex;
            align-items: flex-end;
            gap: 10px;
            max-width: 80%;
        }

        .message .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
        }
        
        .message .text {
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.5;
        }

        /* --- User Message --- */
        .user-message {
            align-self: flex-end;
            flex-direction: row-reverse;
        }
        .user-message .avatar {
            background-color: #cce5ff;
            color: var(--primary-color);
        }
        .user-message .text {
            background-color: var(--user-msg-bg);
            color: var(--user-msg-color);
            border-bottom-right-radius: 4px;
        }

        /* --- AI Message --- */
        .ai-message {
            align-self: flex-start;
        }
        .ai-message .avatar {
            background-color: #f0f0f0;
            color: #555;
        }
        .ai-message .text {
            background-color: var(--ai-msg-bg);
            color: var(--ai-msg-color);
            border-bottom-left-radius: 4px;
        }
        
        /* --- Controls & Record Button --- */
        .chat-controls {
            padding: 1.5rem;
            border-top: 1px solid #e0e0e0;
            text-align: center;
        }

        #recordButton {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: none;
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.4);
        }
        #recordButton:hover {
            background-color: var(--primary-hover);
        }
        #recordButton:active {
             transform: scale(0.95);
        }
        #recordButton.recording {
            background-color: #dc3545; /* Red color when recording */
            box-shadow: 0 0 0 10px rgba(220, 53, 69, 0.3);
            animation: pulse 1.5s infinite;
        }
        
        #recordButton svg {
            width: 32px;
            height: 32px;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.5); }
            70% { box-shadow: 0 0 0 15px rgba(220, 53, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }
        
        /* --- Status --- */
        #status {
            margin-top: 1rem;
            color: #666;
            font-style: italic;
            min-height: 20px;
        }

    </style>
</head>
<body>

    <div class="chat-container">
        <div class="chat-header">Trợ lý Giọng nói AI</div>
        
        <div class="chat-log" id="chatLog">
            <!-- Tin nhắn sẽ được thêm vào đây bằng JavaScript -->
            <div class="ai-message">
                <div class="avatar">AI</div>
                <div class="text">Xin chào! Nhấn nút micro bên dưới để bắt đầu cuộc trò chuyện.</div>
            </div>
        </div>

        <div class="chat-controls">
            <button id="recordButton">
                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M5 3a3 3 0 0 1 6 0v5a3 3 0 0 1-6 0V3z"/>
                    <path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z"/>
                </svg>
            </button>
            <div id="status">Nhấn để nói</div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const recordButton = document.getElementById('recordButton');
        const statusDisplay = document.getElementById('status');
        const chatLog = document.getElementById('chatLog');

        // --- Web Speech API Initialization ---
        // Kiểm tra xem trình duyệt có hỗ trợ SpeechRecognition không
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false; // Chỉ nhận một kết quả cuối cùng
            recognition.lang = 'vi-VN'; // Thiết lập ngôn ngữ tiếng Việt
            recognition.interimResults = false; // Không trả về kết quả tạm thời
            recognition.maxAlternatives = 1;

            // --- State Management ---
            let isRecording = false;

            // --- Event Listeners ---
            recordButton.addEventListener('click', () => {
                if (isRecording) {
                    stopRecording();
                } else {
                    startRecording();
                }
            });

            recognition.onstart = () => {
                isRecording = true;
                recordButton.classList.add('recording');
                statusDisplay.textContent = 'Đang lắng nghe...';
            };

            recognition.onend = () => {
                isRecording = false;
                recordButton.classList.remove('recording');
                statusDisplay.textContent = 'Nhấn để nói';
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                addMessageToLog(transcript, 'user');
                // Gọi hàm xử lý logic AI (hiện tại chỉ là mô phỏng)
                callGeminiAPIMock(transcript);
            };

            recognition.onerror = (event) => {
                console.error('Lỗi nhận diện giọng nói:', event.error);
                statusDisplay.textContent = `Lỗi: ${event.error}`;
                addMessageToLog(`Lỗi nhận diện: ${event.error}`, 'ai');
            };

        } else {
            // Nếu trình duyệt không hỗ trợ
            statusDisplay.textContent = 'Trình duyệt của bạn không hỗ trợ nhận diện giọng nói.';
            recordButton.disabled = true;
            addMessageToLog('Rất tiếc, trình duyệt của bạn không hỗ trợ API nhận diện giọng nói. Vui lòng thử trên Chrome hoặc Edge.', 'ai');
        }


        // --- Functions ---
        function startRecording() {
            if (recognition) {
                recognition.start();
            }
        }

        function stopRecording() {
            if (recognition) {
                recognition.stop();
            }
        }

        // --- UI Functions ---
        function addMessageToLog(text, sender) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', sender === 'user' ? 'user-message' : 'ai-message');
            
            const avatar = document.createElement('div');
            avatar.classList.add('avatar');
            avatar.textContent = sender === 'user' ? 'You' : 'AI';

            const messageText = document.createElement('div');
            messageText.classList.add('text');
            messageText.textContent = text;
            
            messageElement.appendChild(avatar);
            messageElement.appendChild(messageText);

            chatLog.appendChild(messageElement);
            // Tự động cuộn xuống tin nhắn mới nhất
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        // --- Text-to-Speech Function ---
        function speak(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'vi-VN'; // Đảm bảo đọc bằng giọng tiếng Việt
                utterance.rate = 1.0; // Tốc độ đọc (1 là bình thường)
                
                // Đảm bảo không có gì đang nói trước khi phát
                window.speechSynthesis.cancel(); 
                window.speechSynthesis.speak(utterance);
            } else {
                console.error("Trình duyệt không hỗ trợ Text-to-Speech.");
            }
        }
        
        // --- AI Logic (Mock Function) ---
        // Đây là hàm MÔ PHỎNG. Ở các bước sau, chúng ta sẽ thay thế nó bằng
        // một lệnh gọi thực sự đến Firebase Functions và Gemini.
        function callGeminiAPIMock(prompt) {
            statusDisplay.textContent = 'AI đang "suy nghĩ"...';
            const responseText = `(Mô phỏng) Bạn vừa nói: "${prompt}"`;
            
            // Giả lập độ trễ của API
            setTimeout(() => {
                addMessageToLog(responseText, 'ai');
                speak(responseText); // AI đọc câu trả lời
                statusDisplay.textContent = 'Nhấn để nói';
            }, 1000);
        }
        
        // AI chào mừng khi khởi động
        speak("Xin chào! Nhấn nút micro bên dưới để bắt đầu cuộc trò chuyện.");

    </script>
</body>
</html>
